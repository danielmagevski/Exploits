#!/bin/bash
# Backup do Banco SGAP
# 05/04/2010
# Analista: Wellington Santos

# Variaveis
BANCO=SGAP.GDB
DIR_BANCO=/opt/database
DIR_BACKUP=/linux/backup/
ARQUIVO_GBK=sgap_`date "+%d%m%Y%H"`.gbk
ARQUIVO=sgap_`date "+%d%m%Y%H"`.tgz
ARQUIVO_DEL="sgap_$(date +%d%m%Y --date='3 days ago')`date +%H`.tgz"
LOG='/var/log/backup.log'

#Parametros do Email
SENDMAIL='/sbin/sendEmail'
EMAIL='backup@sunlogica.com.br'
SENHA='2s7u6n'
EMAIL_DESTINO='andrade@sundigital.inf.br'
TITULO='MANUTENCAO'
SMTP='smtp.sunlogica.com.br'
PORTA=587

#Funcao para Erro
function email_erro()
{
MENSAGEM="$HOSTNAME - OCORREU UM ERRO NA GRAVACAO DO BACKUP SGAP - VERIFIQUE URGENTE!"
$SENDMAIL -f $EMAIL -t $EMAIL_DESTINO -u $TITULO -m "$MENSAGEM" -s $SMTP:$PORTA -xu $EMAIL -xp $SENHA
}

#Inicia o Backup
cd $DIR_BANCO
/opt/firebird/bin/gbak -g -b -z -v $BANCO $DIR_BACKUP/$ARQUIVO_GBK -user SYSDBA -password masterkey

# COMPACTA ARQUIVO
if
        cd $DIR_BACKUP
        tar cjv $ARQUIVO_GBK -f $ARQUIVO;then
        echo " ${DATE} ${ARQUIVO} - Backup - Realizado com Sucesso" >> ${LOG}
        rm -rf $ARQUIVO_GBK
else
        echo " ${DATE} ${ARQUIVO} - Backup - Ocorreu um erro" >> ${LOG}
        email_erro
        exit 1
fi

#Rotina de Backup para o Demy
DEMY=/linux/revi-rio/dados/Usuarios/Demy/DEMY/backup_sgap
VERIFICA_DATA="$(date +%d)"
VERIFICA_HORA="$(date +%H)"

#Funcao para Erro
function email_alerta()
{
MENSAGEM="$HOSTNAME - COPIA DEMMY - REALIZADA COM SUCESSO !"
$SENDMAIL -f $EMAIL -t $EMAIL_DESTINO -u $TITULO -m "$MENSAGEM" -s $SMTP:$PORTA -xu $EMAIL -xp $SENHA
}

if [ $VERIFICA_HORA == 06 ] ; then
	#DIA 01
	if [ $VERIFICA_DATA == 01 ]; then
	        cp $DIR_BACKUP/$ARQUIVO $DEMY
	email_alerta
	fi
	#DIA 10
	if [ $VERIFICA_DATA == 10 ] ; then
	        cp $DIR_BACKUP/$ARQUIVO $DEMY
	email_alerta
	fi
	#DIA 20
	if [ $VERIFICA_DATA == 20 ] ; then
		cp $DIR_BACKUP/$ARQUIVO $DEMY
	email_alerta
	fi
	#DIA 30
	if [ $VERIFICA_DATA == 30 ] ; then
		cp $DIR_BACKUP/$ARQUIVO $DEMY
	email_alerta
	fi
	if [ $VERIFICA_DATA == 31 ] ; then
                cp $DIR_BACKUP/$ARQUIVO $DEMY
        email_alerta
        fi
fi
