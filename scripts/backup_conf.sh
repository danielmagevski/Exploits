#!/bin/bash
#Backup de Configuracoes
#Analista: Wellington Santos
#Criado: 16/07/2007
#Modificado: 12/10/09

CLIENTE='REVI-RIO'
# Caminho dos confs que irao serem copiados
ETC=/etc
NETLOGON=/linux/netlogon
SCRIPTS=/linux/scripts
MRTG=/usr/lib/mrtg2
LDAP=/var/lib/ldap
NAGIOS=/usr/local/nagios
FIREWALL=/linux/firewall

#Variaveis Globais
DIR_BACKUP=/linux/backup
ARQUIVO=`date "+%d%m%Y"`bkconfs-${HOSTNAME}.tar
ARQUIVO_DEL="$(date +%d%m%Y --date='3 days ago')bkconfs-${HOSTNAME}.tar"
DATE="`date "+%d%m%Y-%H:%M:%S"`"
PASTA=`date "+%d%m%Y"`
LOG=/var/log/"backup".log
FTP_HOST="10.10.50.14"
FTP_USER="bkti"
FTP_PASS="6h1a8i3d1a4r"

#Parametros do Email
SENDMAIL='/sbin/sendEmail'
EMAIL='backup@sunlogica.com.br'
SENHA='2s7u6n'
EMAIL_DESTINO='suporte@tribosys.com.br'
TITULO="MANUTENCAO - $CLIENTE"
SMTP='smtp.sunlogica.com.br'
PORTA=25

#Funcao para Erro
function email_erro()
{
MENSAGEM="$HOSTNAME - OCORREU UM ERRO NA GRAVACAO DO BACKUP CONF - VERIFIQUE URGENTE!"
$SENDMAIL -f $EMAIL -t $EMAIL_DESTINO -u $TITULO -m "$MENSAGEM" -s $SMTP:$PORTA -xu $EMAIL -xp $SENHA
}

# Cria Diretorio Temporario para copia dos arquivos
mkdir ${DIR_BACKUP}/${PASTA}

# COPIAS DIVERSAS
crontab -l >> ${DIR_BACKUP}/${PASTA}/crontab.txt
cp /etc/init.d/firewall  ${DIR_BACKUP}/${PASTA}/firewall.sh
cp -R /var/named/*.com.br  ${DIR_BACKUP}/${PASTA}
cp -R /var/named/*.org.br  ${DIR_BACKUP}/${PASTA}

cp -R -r -f -p ${ETC} ${NETLOGON} ${SCRIPTS} ${MRTG} ${LDAP} ${NAGIOS} ${FIREWALL} ${DIR_BACKUP}/${PASTA}

# COMPACTA ARQUIVOS / GRAVA MYSQL
if 
	cd ${DIR_BACKUP}/${PASTA}/
       	tar cjvf ${DIR_BACKUP}/${ARQUIVO} **;then
	echo " ${DATE} ${ARQUIVO} - Backup - Realizado com Sucesso" >> ${LOG}
else
	echo " ${DATE} ${ARQUIVO} - Backup - Ocorreu um erro" >> ${LOG}
#	email_erro
	exit 1
fi

## Remove Arquivos Temporarios
rm -rf ${DIR_BACKUP}/${PASTA}
rm -rf ${DIR_BACKUP}/${ARQUIVO_DEL}

#Rotina SSH
#scp ${DIR_BACKUP}/${ARQUIVO} root@192.168.0.90:/linux/backup

#Rotina FTP
#cd ${DIR_BACKUP}
#ftp -in <<EOF
#open ${FTP_HOST}
#user ${FTP_USER} ${FTP_PASS}
#bin
#hash
#prompt
#delete ${ARQUIVO_DEL}
#put ${ARQUIVO}
#bye
#EOF

#Monitora Espaco em Disco
SUPORTADO=80
DISPOSITIVO="/dev/sda3"
ESPACO=$(df -h $DISPOSITIVO | awk '{print $5}' | cut -d "%" -f1 | tail -n1)
MENSAGEM="$HOSTNAME - ESPACO EM DISCO $ESPACO % ($DISPOSITIVO) - VERIFIQUE!"

if [ $ESPACO -gt $SUPORTADO ] ; then
sendEmail -f $EMAIL -t $EMAIL_DESTINO -u $TITULO -m "$MENSAGEM" -s $SMTP:$PORTA -xu $EMAIL -xp $SENHA
fi

#DISCO RAID
SUPORTADO=80
DISPOSITIVO="/dev/md0"
ESPACO=$(df -h $DISPOSITIVO | awk '{print $5}' | cut -d "%" -f1 | tail -n1)
MENSAGEM="$HOSTNAME - ESPACO EM DISCO $ESPACO % ($DISPOSITIVO) - VERIFIQUE!"

if [ $ESPACO -gt $SUPORTADO ] ; then
sendEmail -f $EMAIL -t $EMAIL_DESTINO -u $TITULO -m "$MENSAGEM" -s $SMTP:$PORTA -xu $EMAIL -xp $SENHA
fi
